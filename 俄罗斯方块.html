<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8" />
	<style type="text/css">
		div{
			margin: 40px auto;
			height:650px;
			width:520px;
			text-align:center;
		}
	</style>
</head>
<body>
<div>
<canvas id="els" width="500px" height="630px"></canvas></div>
<span id="msg"></span>
<script type="text/javascript">
	var canvas = document.getElementById("els");
	var ctx = canvas.getContext("2d");
	var Scol=10;//列数
	var Srow=20;//行数
	var ScellSize=30;//格子大小


	//点
	var Point=function(x,y){
		this.x=x;
		this.y=y;
	}

	//七种图形
	var Graph = function (type, x, y, state, offsetX = 10) { // 1  I  2 O  3  T  4 Z  5  反Z   6  L  7 反L 
		this.type=type;//类型
		this.points = new Array();
		this.centerPoint = new Point(x, y); //中心点
		this.color="#000";
    this.offsetX = offsetX;
    this.offsetY = 10;
		this.state=state;//旋转状态
		this.cellSize = 30;
		switch(type){//生成各方块坐标
			case 1:
        this.points[0] = new Point(-1, 0);
        this.points[1] = new Point(0, 0);
        this.points[2] = new Point(1, 0);
        this.points[3] = new Point(2, 0);
				this.color="#000";
				break;
      case 2:
        this.points[0] = new Point(0, -1);
        this.points[1] = new Point(1, -1);
        this.points[2] = new Point(0, 0);
        this.points[3] = new Point(1, 0);
        this.color = '#770000';
        break;
      case 3:
        this.points[0] = new Point(0, -1);
        this.points[1] = new Point(-1, 0);
        this.points[2] = new Point(0, 0);
        this.points[3] = new Point(1, 0);
        this.color = '#dd0000';
        break;
      case 4:
        this.points[0] = new Point(-1, -1);
        this.points[1] = new Point(0, -1);
        this.points[2] = new Point(0, 0);
        this.points[3] = new Point(1, 0);
        this.color = '#007700';
        break;
      case 5:
        this.points[0] = new Point(-1, 0);
        this.points[1] = new Point(0, -1);
        this.points[2] = new Point(0, 0);
        this.points[3] = new Point(1, -1);
        this.color = '#00dd00';
        break;
      case 6:
        this.points[0] = new Point(-1, 0);
        this.points[1] = new Point(0, 0);
        this.points[2] = new Point(1, 0);
        this.points[3] = new Point(1, -1);
        this.color = '#000077';
        break;
      case 7:
        this.points[0] = new Point(-1, -1);
        this.points[1] = new Point(-1, 0);
        this.points[2] = new Point(0, 0);
        this.points[3] = new Point(1, 0);
        this.color = '#0000dd';
		}
		this.draw=function(){//绘制图形
			for (var i = 0; i < this.points.length; i++) {
				ctx.beginPath();
				ctx.strokeStyle = "#fff";
				ctx.strokeRect(this.offsetX + (this.points[i].x + this.centerPoint.x) * ScellSize, this.offsetY + (this.points[i].y + this.centerPoint.y) * ScellSize, this.cellSize, this.cellSize);
				ctx.strokeStyle = "#000";
				ctx.fillStyle = this.color;
				ctx.fillRect(this.offsetX + (this.points[i].x + this.centerPoint.x) * ScellSize, this.offsetY + (this.points[i].y + this.centerPoint.y) * ScellSize, this.cellSize, this.cellSize);
				ctx.fillStyle = "#000";
			}
		}
		this.clears=function(){//清除
			for (var i = 0; i < this.points.length; i++) {
				ctx.clearRect(this.offsetX + (this.points[i].x + this.centerPoint.x) * ScellSize, this.offsetY + (this.points[i].y + this.centerPoint.y) * ScellSize, this.cellSize, this.cellSize);
			}
		}
		this.rotateL=function(){//逆时针旋转
			for(var i=0;i<this.points.length;i++){
				x=this.points[i].x;
				y=this.points[i].y;
				this.points[i].x=-1*y;
				this.points[i].y=x;
			}
		}
		this.rotateR=function(){//顺指针旋转
			for (var i = 0; i < this.points.length; i++) {
				x=this.points[i].x;
				y=this.points[i].y;
				this.points[i].x=y;
				this.points[i].y=-1*x;
			}
		}
		this.rotate0=function(){//旋转
			if(this.type==1||this.type==4||this.type==5){
				if(this.state==1||this.state==3){
					this.rotateL();
					this.state++;
				}else{
					this.rotateR();
					if(this.state==4){
						this.state=1;
					}else{
						this.state++;
					}
				}
			}else{
				this.rotateL();
			}
		}
		this.rotate1=function(){//判断是否能旋转时 旋转
			if(this.type==1||this.type==4||this.type==5){
				if(this.state==1||this.state==3){
					this.rotateL();
				}else{
					this.rotateR();
				}
			}else{
				this.rotateL();
			}
		}
		this.rotate2=function(){//判断是否能旋转时 回转
			if(this.type==1||this.type==4||this.type==5){
				if(this.state==1||this.state==3){
					this.rotateR();

				}else{
					this.rotateL();
				}
			}else{
				this.rotateR();
			}
		}
		this.rotate=function(){//旋转
			this.clears();
			this.rotate0();
			this.draw();
		}
		this.drop=function(){//下落
			this.clears();
			this.centerPoint.y++;
			this.draw();
		}
		this.moveleft=function(){//左移
			this.clears();
			this.centerPoint.x--;
			this.draw();
		}
		this.moveright=function(){//右移
			this.clears();
			this.centerPoint.x++;
			this.draw();
		}
		for(var i=1;i<this.state;i++){
			this.rotate();
		}
	}

	//面板
	var panel = {
		col:Scol,//列数
		row:Srow,//行数
		score:0,//分数
		cellSize:ScellSize,//格子大小
		cells:new Array(),//格子状态集合
		draw:function(){//绘制主体面板
			ctx.beginPath();
			ctx.lineWidth=3;
			ctx.strokeRect(8,8,(this.col+6)*this.cellSize,this.row*this.cellSize);
			ctx.lineWidth=2;
			ctx.beginPath();
			ctx.lineTo(11+this.col*this.cellSize,10);
			ctx.lineTo(11+this.col*this.cellSize,10+this.row*this.cellSize);
			ctx.stroke();
			ctx.lineWidth=1;
		},
		drawScore:function(){//绘制分数
			ctx.clearRect(10+(this.col+1)*this.cellSize,20,120,30);
			ctx.font="16px 楷书";
			ctx.fillText("分数：",10+(this.col+1)*this.cellSize,10+this.cellSize);
			ctx.fillStyle="#f00";
			ctx.fillText(this.score,10+(this.col+2.5)*this.cellSize,10+this.cellSize);
			ctx.fillStyle="#000";
		},
		getCells:function(){//获取面板格子状态
			var ccs = new  Array();
			for(var i=0;i<this.col;i++){
				var cs = new Array();
				for(var j=0;j<this.row;j++){
					cs[j] = {
						has: false,
						color: '',
					};
				}
				ccs[i]=cs;
			}
			return ccs;
		},
		drawNext:function(){//绘制下一个图形
			ctx.clearRect(10 + (this.col + 0.5) * this.cellSize, 2 * this.cellSize, 160, 120);
			type=Math.floor(Math.random()*7)+1;
			var g=new Graph(type,13,3,1, 0);
			g.draw();
			return g;
		},
		drawNow:function(){//绘制当前图形
			type=Math.floor(Math.random()*7)+1;
			var g=new Graph(type,5,2,1);
			g.draw();
			return g;
		},
		isDrop:function(){//判断面板内图形是否能下移
			var x = this.nowG.centerPoint.x;
			var y = this.nowG.centerPoint.y + 1;
			for (var i = 0; i < this.nowG.points.length; i++) {
				if (this.nowG.points[i].y + y >= this.row || this.cells[this.nowG.points[i].x + x][this.nowG.points[i].y + y].has) {
					return false;
				}
			}
			return true;
		},
		isMoveleft:function(){//判断面板内图形是否能左移
			var x = this.nowG.centerPoint.x - 1;
			var y = this.nowG.centerPoint.y;
			for (var i = 0; i < this.nowG.points.length; i++) {
				if (this.nowG.points[i].x + x < 0 || this.cells[this.nowG.points[i].x + x][this.nowG.points[i].y + y].has) {
					return false;
				}
			}
			return true;
		},
		isMoveright:function(){//判断面板内图形是否能右移
			var x = this.nowG.centerPoint.x + 1;
			var y = this.nowG.centerPoint.y;
			for (var i = 0; i < this.nowG.points.length; i++) {
				if (this.nowG.points[i].x + x >= this.col || this.cells[this.nowG.points[i].x + x][this.nowG.points[i].y + y].has) {
					return false;
				}
			}
			return true;
		},
		isrotate:function(){//判断面板内图形是否能旋转
			this.nowG.rotate1();
			var x = this.nowG.centerPoint.x;
			var y = this.nowG.centerPoint.y;
			for (var i = 0; i < this.nowG.points.length; i++) {
				if (this.nowG.points[i].x + x < 0 || this.nowG.points[i].x + x >= this.col || this.nowG.points[i].y + y < 0 || this.nowG.points[i].y + y >= this.row || this.cells[this.nowG.points[i].x + x][this.nowG.points[i].y + y].has){
					this.nowG.rotate2();
					return false;
				}
			}
			this.nowG.rotate2();
			return true;
		},
		drawCells() {
			ctx.clearRect(8, 8, this.col * this.cellSize, this.row * this.cellSize);
			for (var i = 0; i < this.col; i++) {
				for (var j = 0; j < this.row; j++) {
					if (this.cells[i][j].has) {
						ctx.fillStyle = this.cells[i][j].color;
						ctx.fillRect(10 + i * this.cellSize, 10 + j * this.cellSize, this.cellSize, this.cellSize);
					}
				}
			}
		},
		checkRow() {
			var rowMoveNumArr = [];
			var moveNum = 0;
			for (var i = this.row - 1; i >= 0; i--) {
				var n = 0;
				for (var j = this.col - 1; j >= 0; j--) {
					if (!this.cells[j][i].has) {
						break;
					} else {
						n++;
					}
				}
				var obj = {
					removeFlag: false,
					moveNum: 0,
				}
				if (n === this.col) {
					obj.removeFlag = true;
				}
				obj.moveNum = moveNum;
				rowMoveNumArr[i] = obj;
				if (n === this.col) {
					moveNum++;
				}
			}
			this.score += moveNum;
			this.drawScore();
			for (var i = this.row - 1; i >= 0; i--) {
				if (rowMoveNumArr[i].moveNum > 0) {
					for (var j = 0; j < this.col; j++) {
						if (!rowMoveNumArr[i].removeFlag) {
							this.cells[j][i + rowMoveNumArr[i].moveNum].has = this.cells[j][i].has;
							this.cells[j][i + rowMoveNumArr[i].moveNum].color = this.cells[j][i].color;
						}
						this.cells[j][i].has = false;
					}
				}
			}
		},
		land:function(){//面板内图形着陆
			const x = this.nowG.centerPoint.x;
			const y = this.nowG.centerPoint.y;
			for (var i = 0; i < this.nowG.points.length; i++) {
				const cell = this.cells[this.nowG.points[i].x + x][this.nowG.points[i].y + y];
				cell.has = true;
				cell.color = this.nowG.color;
			}
    	this.checkRow();
			this.drawCells();
		},
		rotate:function(){//面板内图形旋转
			if(this.isrotate()){
				this.nowG.rotate();
			}
		},
		moveleft:function(){//面板内图形左移
			if(this.isMoveleft()){
				this.nowG.moveleft();
			}
		},
		moveright:function(){//面板内图形右移
			if(this.isMoveright()){
				this.nowG.moveright();
			}
		},
		drop:function(){//面板内图形下落
				if(this.isDrop()){
					this.nowG.drop();
				}else{
					this.land();
					this.nowG = this.nextG;
					this.nowG.offsetX = 10;
					this.nowG.centerPoint.x = 5;
					this.nowG.centerPoint.y = 2;
					this.nowG.draw();
					this.nextG=this.drawNext();
				}
		},
		init:function(){//面板初始化
			this.cells=this.getCells();//格子状态初始化
			this.draw();//绘制面板
			this.drawScore();//绘制初始化分数
			this.nowG=this.drawNow();//当前图形
			this.nextG=this.drawNext();//下一个图形
		}
	}
	panel.init();
	document.onkeydown=function(e){
		switch(e.keyCode){
			case 37:
				panel.moveleft();
				break;
			case 38:
				panel.rotate();
				break;
			case 39:
				panel.moveright();
				break;
			case 40:
				panel.drop();
				break;
		}
	}
	setInterval(function(){//自动下落
		panel.drop();
	},1000);
</script>
</body>
</html>