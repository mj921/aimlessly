<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <style>
        body,div,dl,dt{
            padding: 0;
            margin: 0;
        }
        body{
            text-align: center;
        }
        #main{
            display: inline-block;
        }

        #panel{
            position: relative;
            margin: 10px auto;
            padding: 4px;
            width: 500px;
            border-radius: 3px;
            border:1px solid #c0c0c0;
            zoom:1;
            background-color: #b9ac9f;
        }
        #panel:after{
            content: "";
            display: block;
            clear: both;
        }
        #panel dl{
            position: absolute;
            margin: 4px;
            width: 42px;
            height: 42px;
            line-height: 42px;
            text-align: center;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s
        }
        #panel dl.bg{
            float: left;
            position: relative;
            background-color: #cbbeb0;
        }
        #panel dl.num2{
            background-color: #06f6cc;
            color: #786d63;
            font-size: 24px;
        }
        #panel dl.num4{
            background-color: #06f688;
            color: #786d63;
            font-size: 24px;
        }
        #panel dl.num8{
            background-color: #05e129;
            color: #fff;
            font-size: 24px;
        }
        #panel dl.num16{
            background-color: #38b103;
            color: #fff;
            font-size: 23px;
        }
        #panel dl.num32{
            background-color: #38b103;
            color: #fff;
            font-size: 23px;
        }
        #panel dl.num64{
            background-color: #38b103;
            color: #fff;
            font-size: 23px;
        }
        #panel dl.num128{
            background-color: #38b103;
            color: #fff;
            font-size: 22px;
        }
        #panel dl.num256{
            background-color: #38b103;
            color: #fff;
            font-size: 22px;
        }
        #panel dl.num512{
            background-color: #38b103;
            color: #fff;
            font-size: 22px;
        }
        #panel dl.num1024{
            background-color: #38b103;
            color: #fff;
            font-size: 21px;
        }
        #panel dl.num16{
            background-color: #38b103;
            color: #fff;
            font-size: 23px;
        }
        #panel dl.num16{
            background-color: #38b103;
            color: #fff;
            font-size: 23px;
        }
        #panel dl.num16{
            background-color: #38b103;
            color: #fff;
            font-size: 23px;
        }
    </style>
</head>
<body>
    <div id="main">
        <dl id="max">最高分:0</dl><dl id="curr">当前分数:0</dl>
        <div id="panel"></div>
    </div>
    <script>
        var max = document.getElementById("max");
        var curr = document.getElementById("curr");
        var Cell = function(x,y,ele,num){
            this.x = x;
            this.y = y;
            this.ele = ele;
            this.num = num || 2;
            this.ele.className = "num" + this.num;
            this.ele.innerText = this.num;
            this.ele.style.left = this.x * 50 + 4 + "px";
            this.ele.style.top = this.y * 50 + 4 + "px";
        }
        Cell.prototype.setNum = function(num){
            this.num = num;
            this.ele.className = "num" + this.num;
            this.ele.innerText = this.num;
        }
        Cell.prototype.changeEle = function(){
            this.ele.className = "num" + this.num;
            this.ele.innerText = this.num;
            this.ele.style.left = this.x * 50 + 4 + "px";
            this.ele.style.top = this.y * 50 + 4 + "px";
        }
        //面板对象
        var panel = {
            cells:[],
            obj:document.getElementById("panel"),
            rows:8,//行数
            types:0,//标技数
            size:50,//格子大小
            status:true,
            score:0,//分数
            maxScore:0,//最高分
            //创建背景格子
            createbg:function(){
                for(var i = 0;i < this.rows * this.rows;i++){
                    var dl = document.createElement("dl");
                    dl.className = "bg";
                    this.obj.appendChild(dl);
                }
            },
            //创建空格子数组
            createCells:function(){
                for(var i = 0;i < this.rows;i++){
                    var cs = []
                    for(var j = 0;j < this.rows;j++){
                        cs[j] = null;
                    }
                    this.cells[i] = cs;
                }
            },
            //随机创建格子
            createCell:function(){
                var x,y;
                var flag = true;
                while(flag){
                    flag = false;
                    x = ~~(Math.random() * this.rows);
                    y = ~~(Math.random() * this.rows);
                    for(var i = 0;i < this.rows;i++){
                        for(var j = 0;j < this.rows;j++){
                            if(this.cells[i][j] && this.cells[i][j].x === x && this.cells[i][j].y === y){
                                flag = true;
                                break;
                            }
                        }
                    }
                }
                var ele = document.createElement("dl");
                this.obj.appendChild(ele);
                this.cells[x][y] = new Cell(x,y,ele);
            },
            getSize:function(){
                var l = 0;
                for(var i = 0;i < this.rows;i++){
                    for(var j = 0;j < this.rows;j++){
                        this.cells[i][j] && l++;
                    }
                }
                return l;
            },
            //判断能否移动
            isMove:function(type){
                switch(type){
                    case 37:
                        for(var j = 0;j < this.rows;j++){
                            var c = this.cells[this.rows - 1][j];
                            var flag = c === null;
                            for(var i = 1;i < this.rows;i++){
                                if(this.cells[i][j] !== null && (flag || this.cells[i][j].num === c.num)){
                                    return true;
                                }
                                c = this.cells[i][j];
                                flag = c === null; 
                            }
                        }
                        break;
                    case 38:
                        for(var i = 0;i < this.rows;i++){
                            var c = this.cells[i][0];
                            var flag = c === null;
                            for(var j = 1;j < this.rows;j++){
                                if(this.cells[i][j] !== null && (flag || this.cells[i][j].num === c.num)){
                                    return true;
                                }
                                c = this.cells[i][j];
                                flag = c === null; 
                            }
                        }
                        break;
                    case 39:
                        for(var j = 0;j < this.rows;j++){
                            var c = this.cells[this.rows - 1][j];
                            var flag = c === null;
                            for(var i = this.rows - 2;i >= 0;i--){
                                if(this.cells[i][j] !== null && (flag || this.cells[i][j].num === c.num)){
                                    return true;
                                }
                                c = this.cells[i][j];
                                flag = c === null; 
                            }
                        }
                        break;
                    case 40:
                        for(var i = 0;i < this.rows;i++){
                            var c = this.cells[i][this.rows - 1];
                            var flag = c === null;
                            for(var j = this.rows - 2;j >= 0;j--){
                                if(this.cells[i][j] !== null && (flag || this.cells[i][j].num === c.num)){
                                    return true;
                                }
                                c = this.cells[i][j];
                                flag = c === null; 
                            }
                        }
                }
                return false;
            },
            //判断是否死亡
            isDeath:function(){
                if(!this.isMove(37) && !this.isMove(38) && !this.isMove(39) && !this.isMove(40)){
                    for(var i = 0;i < this.rows;i++){
                        for(var j = 0;j < this.rows;j++){
                            if(this.cells[i][j] === null){
                                return false;
                            }
                        }
                    }
                    return true;
                }else{
                    return false;
                }
            },
            //开始监听键盘事件
            startKeyLinster:function(){
                var self = this;
                document.onkeydown = function(e){
                    if(self.status && e.keyCode > 36 && e.keyCode < 41){
                        if(!self.isMove(e.keyCode)){
                            return;
                        }
                        switch(e.keyCode){
                            case 37:
                                for(var j = 0;j < self.rows;j++){
                                    var n = 0;
                                    for(var i = 0;i < self.rows;i++){
                                        if(self.cells[i][j] !== null && n !== i){
                                            if(self.cells[n][j] === null){
                                                self.cells[n][j] = new Cell(n,j,self.cells[i][j].ele,self.cells[i][j].num);
                                                self.cells[i][j] = null;
                                            }else{
                                                if(self.cells[n][j].num === self.cells[i][j].num){
                                                    self.cells[n][j].setNum(self.cells[n][j].num * 2);
                                                    self.obj.removeChild(self.cells[i][j].ele);
                                                    self.cells[i][j] = null;
                                                    self.score += self.cells[n][j].num;
                                                }else if(self.cells[i][j] !== null){
                                                    n++;
                                                    if(n !== i){
                                                        self.cells[n][j] = new Cell(n,j,self.cells[i][j].ele,self.cells[i][j].num);
                                                        self.cells[i][j] = null;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                break;
                            case 38:
                                for(var i = 0;i < self.rows;i++){
                                    var n = 0;
                                    for(var j = 0;j < self.rows;j++){
                                        if(self.cells[i][j] !== null && n !== j){
                                            if(self.cells[i][n] === null){
                                                self.cells[i][n] = new Cell(i,n,self.cells[i][j].ele,self.cells[i][j].num);
                                                self.cells[i][j] = null;
                                            }else{
                                                if(self.cells[i][n].num === self.cells[i][j].num){
                                                    self.cells[i][n].setNum(self.cells[i][n].num * 2);
                                                    self.obj.removeChild(self.cells[i][j].ele);
                                                    self.cells[i][j] = null;
                                                    self.score += self.cells[i][n].num;
                                                }else if(self.cells[i][j] !== null){
                                                    n++;
                                                    if(n !== j){
                                                        self.cells[i][n] = new Cell(i,n,self.cells[i][j].ele,self.cells[i][j].num);
                                                        self.cells[i][j] = null;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                break;
                            case 39:
                                for(var j = 0;j < self.rows;j++){
                                    var n = self.rows - 1;
                                    for(var i = self.rows - 1;i >= 0;i--){
                                        if(self.cells[i][j] !== null && n !== i){
                                            if(self.cells[n][j] === null){
                                                self.cells[n][j] = new Cell(n,j,self.cells[i][j].ele,self.cells[i][j].num);
                                                self.cells[i][j] = null;
                                            }else{
                                                if(self.cells[n][j].num === self.cells[i][j].num){
                                                    self.cells[n][j].setNum(self.cells[n][j].num * 2);
                                                    self.obj.removeChild(self.cells[i][j].ele);
                                                    self.cells[i][j] = null;
                                                    self.score += self.cells[n][j].num;
                                                }else if(self.cells[i][j] !== null){
                                                    n--;
                                                    if(n !== i){
                                                        self.cells[n][j] = new Cell(n,j,self.cells[i][j].ele,self.cells[i][j].num);
                                                        self.cells[i][j] = null;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                break;
                            case 40:
                                for(var i = 0;i < self.rows;i++){
                                    var n = self.rows - 1;
                                    for(var j = self.rows - 1;j >= 0;j--){
                                        if(self.cells[i][j] !== null && n !== j){
                                            if(self.cells[i][n] === null){
                                                self.cells[i][n] = new Cell(i,n,self.cells[i][j].ele,self.cells[i][j].num);
                                                self.cells[i][j] = null;
                                            }else{
                                                if(self.cells[i][n].num === self.cells[i][j].num){
                                                    self.cells[i][n].setNum(self.cells[i][n].num * 2);
                                                    self.obj.removeChild(self.cells[i][j].ele);
                                                    self.cells[i][j] = null;
                                                    self.score += self.cells[i][n].num;
                                                }else if(self.cells[i][j] !== null){
                                                    n--;
                                                    if(n !== j){
                                                        self.cells[i][n] = new Cell(i,n,self.cells[i][j].ele,self.cells[i][j].num);
                                                        self.cells[i][j] = null;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                break;
                        }
                        self.createCell();
                        self.status = false;
                        var ms = +(sessionStorage.getItem("maxScore") || 0);
                        self.maxScore = ms > self.score ? ms : self.score;
                        sessionStorage.setItem("maxScore",self.maxScore);
                        max.innerText = "最高分:" + self.maxScore;
                        curr.innerText = "当前分数:" + self.score;
                        if(self.isDeath()){
                            alert("游戏结束");
                        }else{
                            setTimeout(function(){
                                self.status = true;
                            },300);
                        }
                    }
                }
            },
            init:function(){
                this.status = true,
                this.score = 0;
                this.maxScore = +(sessionStorage.getItem("maxScore") || 0);
                max.innerText = "最高分:" + this.maxScore;
                this.obj.innerHTML = "";
                this.obj.style.width = this.rows * this.size + "px";
                this.obj.style.height = this.rows * this.size + "px";
                this.createbg();
                this.createCells();
                this.createCell();
                this.startKeyLinster();
            }
        }
        panel.init();
    </script>
</body>
</html>